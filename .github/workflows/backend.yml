name: Helping Hands CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    env:
      TEST_MODE: '1'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt || true
        pip install pytest httpx pytest-asyncio pytest-cov

    - name: Run backend tests with coverage
      run: |
        cd src
        pytest tests/ --cov=./ --cov-report=xml --cov-fail-under=75 -v --tb=short

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: backend-coverage-report
        path: src/coverage.xml

  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install frontend dependencies
      run: |
        cd src/frontend
        npm install
        
    - name: Build frontend
      run: |
        cd src/frontend
        npm run build
        
    - name: Run frontend tests
      run: |
        cd src/frontend
        npm test -- --watchAll=false --passWithNoTests

  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install linting tools
      run: |
        pip install flake8
        
    - name: Run Python linter
      run: |
        # Allow the linter to fail without stopping the workflow
        flake8 src --count --max-line-length=120 --statistics --exclude=_pycache_,*.pyc,venv,env,.git || true

  integration-test:
    name: Integration Test
    needs: [backend-test, frontend-test]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install backend dependencies
      run: |
        pip install -r requirements.txt || pip install fastapi uvicorn sqlalchemy python-multipart
        
    - name: Initialize and start backend
      run: |
        # Use your actual run.py file
        python run.py &
        sleep 10
        
    - name: Test backend health
      run: |
        curl -f http://localhost:8000/health || curl -f http://localhost:8000/ || echo "Health check endpoint not found, but server may be running"

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety
        
    - name: Generate Security Reports
      run: |
        # Generate JSON report for processing
        bandit -r src/backend -f json -o bandit-report.json || true
        # Generate readable text report
        bandit -r src/backend -ll -f txt -o bandit-report.txt || true
        
        # Print summary of findings without failing
        echo "=== Security Scan Summary ==="
        if grep -q '"issue_severity": 3' bandit-report.json; then
          echo "High severity issues found - Please review bandit-report.txt"
        elif grep -q '"issue_severity": 2' bandit-report.json; then
          echo "Medium severity issues found - Please review bandit-report.txt"
        else
          echo "No high/medium severity issues found"
        fi
        
    - name: Check dependencies
      run: |
        # Generate safety report without failing
        safety check --output text > safety-report.txt || true
        echo "Dependencies checked - See safety-report.txt for details"
        
    - name: Upload Security Reports
      uses: actions/upload-artifact@v4
      with:
        name: security-reports
        path: |
          bandit-report.json
          bandit-report.txt
          safety-report.txt

  notify:
    name: Build Status
    needs: [backend-test, frontend-test, lint, integration-test, security-scan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Check status
      run: |
        if [ "${{ needs.backend-test.result }}" = "success" ] && \
           [ "${{ needs.frontend-test.result }}" = "success" ] && \
           [ "${{ needs.integration-test.result }}" = "success" ]; then
          echo "All tests passed! Ready for merge."
        else
          echo "Some tests failed. Please check the logs."
          exit 1
        fi